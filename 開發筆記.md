# IThome Bot 開發筆記

## 系統概述

IThome Bot 是一個自動化的 LINE 機器人，主要功能包括：

1. 定期爬取 IThome 網站的最新文章
2. 過濾出新發布的文章（與歷史記錄比對）
3. 提取文章內容
4. 使用 Gemini AI 生成文章摘要
5. 通過 LINE Messaging API 將新聞和摘要發送給用戶

## 系統架構

系統由以下幾個主要模組組成：

### 1. 爬蟲模組 (`crawler.py`)

- `IThome_crawler()`: 爬取 IThome 首頁的最新文章連結，與歷史記錄比對找出新文章
- `get_article_content()`: 爬取文章內容並保存到 `content.txt` 文件中

### 2. 摘要生成模組 (`gemini_test.py`)

- `gen_summary()`: 使用 Google Gemini AI 模型讀取 `content.txt` 中的文章內容，生成摘要

### 3. LINE 訊息發送模組 (`main.py`)

- `send_message()`: 發送文字訊息
- `send_flex_message()`: 發送 Flex 訊息（富媒體訊息）
- `send_batch_messages()`: 批次發送多條訊息
- `send_IT_message()`: 整合爬蟲、摘要和發送功能的主函數

### 4. 排程模組

- 使用 `apscheduler` 設定定時任務，每天早上 9 點執行 `send_IT_message()`

## 運作流程

1. 系統啟動後，通過排程器設定在每天早上 9 點執行主任務
2. 執行時，首先爬取 IThome 網站的最新文章列表
3. 與歷史記錄比對，找出新發布的文章
4. 爬取新文章的內容，保存到 `content.txt`
5. 使用 Gemini AI 生成文章摘要
6. 將新聞和摘要通過 LINE API 發送給用戶

## 2025-04-26 優化：減少 LINE API 消耗量

### 問題描述

原系統設計中，每條新聞都會單獨發送一條訊息，導致 API 呼叫次數過多，容易達到 LINE API 的配額限制。

### 優化方案

1. **使用 Flex Message 合併多條訊息**
   - 將原本每條新聞單獨發送的方式改為使用一個 Flex Message 包含所有新聞
   - 這樣可以將原本需要 N+1 次 API 呼叫（N 條新聞+1 條問候）減少到只需 1 次
   - 新增 `create_news_flex_message()` 函數創建新聞 Flex Message

2. **實現批次發送功能**
   - 新增 `send_batch_messages()` 函數，每批最多發送 5 條訊息
   - 如果 Flex Message 無法使用時，作為備用方案

3. **添加錯誤處理和重試機制**
   - 所有發送函數都增加了重試機制，默認嘗試 3 次
   - 避免因網路問題導致訊息發送失敗

4. **長摘要分段處理**
   - 將長摘要分成多個 2000 字以內的片段發送
   - 避免超過 LINE 訊息長度限制 (約 5000 字)

5. **添加日誌系統**
   - 記錄所有操作和錯誤到日誌文件
   - 方便追蹤和診斷問題

### 效果預估

原本的實現方式，如果有 10 條新聞，需要發送：

- 1 條問候訊息
- 10 條新聞訊息
- 1 條摘要提示
- 1 條摘要內容

共計 13 次 API 呼叫

優化後，只需要：

- 1 條 Flex Message（包含所有新聞）
- 1 條摘要訊息（或分段的摘要）

共計 2-3 次 API 呼叫

這樣可以節省約 80% 的 API 消耗量，大大減少配額用盡的可能性。

### 代碼變更

1. 新增 `send_flex_message()` 和 `send_batch_messages()` 函數
2. 重構 `send_message()` 函數，添加重試機制
3. 修改 `send_IT_message()` 函數，使用 Flex Message 或批次發送
4. 添加日誌系統，記錄操作和錯誤

## 未來優化方向

1. **添加更多錯誤處理**
   - 處理網路連接問題
   - 處理 API 配額限制問題

2. **改進 Flex Message 設計**
   - 添加更多視覺元素
   - 優化排版和用戶體驗

3. **添加用戶互動功能**
   - 允許用戶通過回覆訊息選擇感興趣的新聞
   - 根據用戶興趣推薦相關新聞

4. **優化爬蟲效率**
   - 使用非同步爬蟲提高效率
   - 添加代理和隨機 User-Agent 避免被封鎖

5. **添加監控和報警**
   - 監控系統運行狀態
   - 當出現問題時自動通知管理員